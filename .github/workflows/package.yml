name: Enhanced Security Scan & Package Pipeline

on:
  push:
    branches:
      - main
      - develop
    paths:
      - 'elsai-*/**'
  pull_request:
    branches:
      - main
    paths:
      - 'elsai-*/**'

env:
  PYTHON_VERSION: '3.13'
  PIP_CACHE_DIR: ~/.cache/pip

jobs:
  detect-changes:
    name: 🔍 Detect Changed Folders
    runs-on: ubuntu-latest
    outputs:
      folders: ${{ steps.detect.outputs.folders }}
      matrix: ${{ steps.detect.outputs.matrix }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect changed elsai folders
        id: detect
        run: |
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            base_sha="${{ github.event.pull_request.base.sha }}"
            head_sha="${{ github.event.pull_request.head.sha }}"
          else
            base_sha="${{ github.event.before }}"
            head_sha="${{ github.sha }}"
          fi

          echo "🔍 Comparing $base_sha...$head_sha"

          changed_folders=$(git diff --name-only "$base_sha" "$head_sha" | grep '^elsai-' | cut -d/ -f1 | sort -u || true)

          if [ -z "$changed_folders" ]; then
            echo "❌ No valid elsai-* folders were changed."
            echo "folders<<EOF" >> $GITHUB_OUTPUT
            echo "" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
            echo "matrix={\"include\":[]}" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "📁 Changed folders:"
          echo "$changed_folders" | while read -r folder; do
            echo "  - $folder"
          done

          echo "folders<<EOF" >> $GITHUB_OUTPUT
          echo "$changed_folders" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

          folders_json=$(echo "$changed_folders" | jq -R -s -c 'split("\n") | map(select(length > 0)) | map({folder: .})')
          echo "matrix={\"include\":$folders_json}" >> $GITHUB_OUTPUT
          echo "🔍 Matrix JSON: {\"include\":$folders_json}"

  security-and-package:
    name: 🔐 Security Scan & Package
    needs: detect-changes
    if: needs.detect-changes.outputs.folders != ''
    runs-on: ubuntu-latest
    strategy:
      matrix: ${{ fromJson(needs.detect-changes.outputs.matrix) }}
      fail-fast: false

    env:
      FOLDER: ${{ matrix.folder }}
      EC2_HOST: ${{ secrets.EC2_HOST }}
      EC2_PORT: ${{ secrets.EC2_PORT }}
      PEM_FILE: ${{ secrets.PEM_FILE }}
      SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
      SONAR_PROJECT_KEY: ${{ secrets.SONAR_PROJECT_KEY }}
      SONAR_ORG: ${{ secrets.SONAR_ORG }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: 🐍 Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: 📦 Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install cython python-dotenv setuptools wheel bandit pysonar msal pytest coverage safety poetry

          if [ -f "$FOLDER/requirements.txt" ]; then
            pip install -r "$FOLDER/requirements.txt"
          fi

      - name: 🔑 Setup SSH key
        if: env.PEM_FILE != ''
        run: |
          echo "$PEM_FILE" > Elsai-Package.pem
          chmod 400 Elsai-Package.pem

      - name: 🔍 Validate folder structure
        run: |
          if [ ! -d "$FOLDER" ]; then
            echo "❌ Folder $FOLDER does not exist"
            exit 1
          fi
          ls -la "$FOLDER/"
          if [ ! -f "$FOLDER/package.sh" ]; then
            echo "⚠️ Warning: package.sh not found in $FOLDER"
          else
            echo "✅ package.sh found"
          fi

      - name: 🛡️ Run security scans
        env:
          CLIENT_ID: ${{ secrets.CLIENT_ID }}
          TENANT_ID: ${{ secrets.TENANT_ID }}
          CLIENT_SECRET: ${{ secrets.CLIENT_SECRET }}
        run: |
          cd "$FOLDER" || exit 1

          if [ -f "pyproject.toml" ]; then
            echo "📦 Generating requirements.txt from pyproject.toml"
            poetry self add poetry-plugin-export || true
            poetry export -f requirements.txt --without-hashes -o requirements.txt || poetry show --only=main --format=requirements > requirements.txt || echo "# fallback empty req" > requirements.txt
          elif [ ! -f "requirements.txt" ]; then
            echo "⚠️ No requirements.txt found, creating empty one"
            touch requirements.txt
          fi

          cd ..

          if [ -f "run_security_checks.py" ]; then
            python run_security_checks.py "$FOLDER"
          elif [ -f "testing.py" ]; then
            python testing.py "$FOLDER"
          else
            bandit -r "$FOLDER" -f json -o "bandit-report-$FOLDER.json" || true
          fi

      - name: 🏗️ Run packaging
        if: success()
        run: |
          if [ -f "$FOLDER/package.sh" ]; then
            chmod +x "$FOLDER/package.sh"
            cp Elsai-Package.pem "$FOLDER/" || true
            cd "$FOLDER"
            export EC2_HOST="${{ secrets.EC2_HOST }}"
            export EC2_PORT="${{ secrets.EC2_PORT }}"
            export PEM_FILE_PATH="./Elsai-Package.pem"
            ./package.sh
            PACKAGE_EXIT_CODE=$?
            rm -f "Elsai-Package.pem"
            cd ..
            exit $PACKAGE_EXIT_CODE
          fi

      - name: 🧹 Cleanup SSH key
        if: always() && env.PEM_FILE != ''
        run: |
          rm -f Elsai-Package.pem || true
          find . -name "Elsai-Package.pem" -type f -delete || true

      - name: 📤 Upload build artifacts
        uses: actions/upload-artifact@v4
        if: success()
        with:
          name: build-artifacts-${{ matrix.folder }}
          path: |
            ${{ matrix.folder }}/dist/
            ${{ matrix.folder }}/build/
            ${{ matrix.folder }}/*.tar.gz
            ${{ matrix.folder }}/*.zip
          retention-days: 7

  notify-results:
    name: 📢 Notify Results
    needs: [detect-changes, security-and-package]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: 📋 Job Summary
        run: |
          echo "## 🚀 CI/CD Pipeline Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ needs.detect-changes.outputs.folders }}" == "" ]; then
            echo "❌ **No elsai-* folders were changed**" >> $GITHUB_STEP_SUMMARY
          else
            echo "✅ **Processed the following folders:**" >> $GITHUB_STEP_SUMMARY
            echo "${{ needs.detect-changes.outputs.folders }}" | while read -r folder; do
              if [ -n "$folder" ]; then
                echo "- 📁 \`$folder\`" >> $GITHUB_STEP_SUMMARY
              fi
            done

            if [ "${{ needs.security-and-package.result }}" == "success" ]; then
              echo "🔐 **Security scans:** ✅ Passed" >> $GITHUB_STEP_SUMMARY
              echo "📦 **Packaging:** ✅ Completed" >> $GITHUB_STEP_SUMMARY
            elif [ "${{ needs.security-and-package.result }}" == "failure" ]; then
              echo "❌ **Security scans or packaging failed**" >> $GITHUB_STEP_SUMMARY
            elif [ "${{ needs.security-and-package.result }}" == "skipped" ]; then
              echo "⏭️ **Security scans and packaging were skipped**" >> $GITHUB_STEP_SUMMARY
            fi
          fi
